<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Game</title>
		<style type='text/css'>
			canvas { border: 1px solid black; }
		</style>
	</head>
	<body>
		<canvas id='canvas' width='800' height='600'></canvas>
		<script type='text/javascript' src='raf.js'></script>
		<script type='text/javascript'>
			var ctx;
			
			var left= false, right= false, up= false, down= false;
			
			
			var player = { x: 50, y: 75, w: 60 , h: 65, dx: 5, dy: 5 };

			var count = 0;
			var spriteX;
			var spriteY;

			var waitTime = 100;
			var lastTime = 0;
			
			var lives = 5;
			var platform = { x: 40, y: 500, w: 50, h: 10 };
			
			var MENU = 0, PLAY = 1, GAMEOVER = 2;
			var state = MENU;
			var timerID = -1;
			
			var mouse = { x: 0, y: 0, clicked: false };
			var playButton = {};
			
			(function() {
				var resourceCache = {};
				var loading = [];
				var readyCallbacks = [];

				// Load an image url or an array of image urls
				function load(urlOrArr) {
					if(urlOrArr instanceof Array) {
						urlOrArr.forEach(function(url) {
							_load(url);
						});
					}
					else {
						_load(urlOrArr);
					}
				}

				function _load(url) {
					if(resourceCache[url]) {
						return resourceCache[url];
					}
					else {
						var img = new Image();
						img.onload = function() {
							resourceCache[url] = img;

							if(isReady()) {
								readyCallbacks.forEach(function(func) { func(); });
							}
						};
						resourceCache[url] = false;
						img.src = url;
					}
				}

				function get(url) {
					return resourceCache[url];
				}

				function isReady() {
					var ready = true;
					for(var k in resourceCache) {
						if(resourceCache.hasOwnProperty(k) &&
						   !resourceCache[k]) {
							ready = false;
						}
					}
					return ready;
				}

				function onReady(func) {
					readyCallbacks.push(func);
				}

				window.resources = { 
					load: load,
					get: get,
					onReady: onReady,
					isReady: isReady
				};
			})();
			
			function contains( r, m ) {
				return ! (r.x>m.x || r.y>m.y || m.x>r.x+r.w || m.y>r.y+r.h );
			}

			var KEY_UP = 87, KEY_DOWN = 83, KEY_LEFT = 65, KEY_RIGHT = 68;
			//var altUP = 38, altDOWN = 40, altLEFT = 37, altRIGHT = 39;

			function handleKeyDown(evt) {
				if ( evt.keyCode == KEY_UP )
					up = true;
				if ( evt.keyCode == KEY_DOWN )
					down = true;
				if ( evt.keyCode == KEY_LEFT )
					left = true;
				if ( evt.keyCode == KEY_RIGHT )
					right = true;

				if ( 37 <= evt.keyCode && evt.keyCode <= 40 )
					evt.preventDefault();
			}

			function handleKeyUp(evt) {
				if ( evt.keyCode == KEY_UP )
					up = false;
				if ( evt.keyCode == KEY_DOWN )
					down = false;
				if ( evt.keyCode == KEY_LEFT )
					left = false;
				if ( evt.keyCode == KEY_RIGHT )
					right = false;

				if ( 37 <= evt.keyCode && evt.keyCode <= 40 )
					evt.preventDefault();
			}
			
			function getClick(e) {
				var evt = e || window.event;
				mouse.x = evt.pageX - ctx.canvas.offsetLeft;
				mouse.y = evt.pageY - ctx.canvas.offsetTop;
				mouse.clicked = true;
			}

			function main() {
				ctx = document.getElementById('canvas').getContext("2d");
				document.addEventListener('click', getClick);
				document.addEventListener('drag', getClick);
				document.addEventListener('keydown', handleKeyDown);
				document.addEventListener('keyup', handleKeyUp);
				init();
				changeState(MENU);
			}

			function init()
			{
				ctx.font = "24pt Arial, sans-serif";
				ctx.textBaseline = "top";
				playButton.x = ctx.canvas.width/2 - 100;
				playButton.y = ctx.canvas.height/2 - 50;
				playButton.w = 200;
				playButton.h = 100;
				terrainPattern = ctx.createPattern(resources.get('wood.jpg'), "repeat");

			}
			
			function changeState( newState ) {
				if ( timerID != -1 )
					clearInterval(timerID);
				if ( newState === MENU )
					timerID = setInterval(function() { updateMenu(); drawMenu(ctx); }, 1000/60);
				else if ( newState === PLAY ) {
					reset();
					timerID = setInterval(function() { updatePlay(); drawPlay(ctx); }, 1000/60);
					sprite();
				}
				else if ( newState === GAMEOVER ) {
					waitTime = 2000;
					lastTime = performance.now();
					timerID = setInterval(function() { updateGameOver(); drawGameOver(ctx); }, 1000/60);
				}
				state = newState;
			}
			
			function reset() {
				lives = 5;
				waitTime = 0;
				mouse.clicked = false;
			}
			//******MENU******
			function updateMenu() {
				if ( mouse.clicked && contains(playButton, mouse) === true ) {
					changeState(PLAY);
				}
				mouse.clicked = false;
			}

			function drawMenu(ctx) {
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
				ctx.fillStyle = terrainPattern;
				ctx.fillRect(0,0,canvas.width, canvas.height);
				ctx.strokeRect(playButton.x, playButton.y, playButton.w, playButton.h);
				ctx.fillStyle = "#000000";
				ctx.fillText("[PLAY]", playButton.x+55, playButton.y+30);
			}

			//******PLAY******
			function updatePlay() {
				var orig = { x: player.x, y: player.y };
				
				if (up)
					player.y -= player.dy;
				if (down)
					player.y += player.dy;
				if (left)
					player.x -= player.dx;
				if (right)
					player.x += player.dx;
				
				
				if (collide(player, platform)){
					player.x = orig.x;
					player.y = orig.y;
				}
				
				if (player.x<0)
					player.x=0;
				else if (player.x + player.w  >ctx.canvas.width)
					player.x = ctx.canvas.width-player.w;
				if (player.y < 0)
					player.y=0;
				else if (player.y + player.h > ctx.canvas.height)
					player.y = ctx.canvas.height - player.h;
			}
				
			function collide(player, platform) {
				if(player.x> platform.x + platform.w)
					return false;
				if (player.y > platform.y + platform.h)
						return false;
				if (platform.x > player.x + player.w)
					return false;
				if (platform.y > player.y + player.h ) 
					return false;
					
				return true;
			}
			var spriteLastTime = 0;
			var spriteElapsed;
			var spriteWait = 100;
			function sprite() {
				requestAnimationFrame(sprite);

				spriteX = (count % 10) * 120;
				spriteY = Math.floor(count / 10) * 115;

				var curTime = new Date().getTime();
				if(spriteLastTime == 0)
					spriteLastTime = new Date().getTime();
				spriteElapsed = curTime - spriteLastTime;
				spriteWait -= spriteElapsed;
				spriteLastTime = curTime;

				if ( spriteWait <= 0 && count != 9) {
					count++;
					spriteWait = 100;
				}
				else if(count == 9)
					count = 0;
			}
				
			function drawPlay(ctx) {
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
				ctx.fillRect(platform.x, platform.y, platform.w, platform.h);
				if(left)
					ctx.drawImage(resources.get('linkSheetRunLeft.png'), spriteX, spriteY, 120, 115, player.x, player.y, player.h, player.w);
				else if(right)
					ctx.drawImage(resources.get('linkSheetRunRight.png'), spriteX, spriteY, 120, 115, player.x, player.y, player.h, player.w);
				else
					ctx.drawImage(resources.get('linkSheetIdle.png'), 0, 0, 120, 115, player.x, player.y, player.h, player.w);
			}
			//******GAMEOVER******
			var gameOverWait = 0;
			function updateGameOver() {
				var curTime = performance.now();
				var elapsed = curTime - lastTime;
				waitTime -= elapsed;
				lastTime = curTime;
				if ( waitTime <= 0 )
					changeState(MENU);
			}
					
			function drawGameOver(ctx) {
				ctx.fillText("GAME OVER!", 200, 100);
			}
			
			resources.load([
				'linkSheetIdle.png',
				'linkSheetRunLeft.png',
				'linkSheetRunRight.png',
				'wood.jpg'
			]);
			resources.onReady(main);
		</script>
	</body>
</html>